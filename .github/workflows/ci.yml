name: Piplines for calendar app
on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.12'
            
            - name: Install dependencies
              run: |
                 python -m pip install --upgrade pip
                 pip install flake8
            
            - name: Run Flake8
              run: flake8 calendar_accounts --exclude=migrations --max-line-length=120
    
    test:
        runs-on: ubuntu-latest
        services:
            redis:
                image: redis:latest
                ports:
                    - 6379:6379
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            
            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.12'
            
            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -r requirements.txt
            
            - name: Run migrations
              run: python calendar_planner/manage.py migrate
              env:
                DJANGO_SETTINGS_MODULE: calendar_planner.settings
            
            - name: Run tests
              run: python calendar_planner/manage.py test calendar_api
              env:
                DJANGO_SETTINGS_MODULE: calendar_planner.settings
                REDIS_HOST: redis
    security:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            
            - name: Setup Python
              uses: actions/setup-python@v4
              with:
                python-version: '3.12'

            - name: Install Bandit
              run: |
                python -m pip install --upgrade pip
                pip install bandit
            
            - name: Run security test
              run: bandit -r calendar_api/ calendar_accounts/ -f txt -o security_report.txt || true

            - name: Upload security report
              uses: actions/upload-artifact@v4
              with:
                name: security-report
                path: security-report.txt
                retention-days: 7